name: Build and Release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "ç‰ˆæœ¬ç±»å‹"
        required: true
        type: choice
        options:
          - patch # 1.0.0 -> 1.0.1 (bugä¿®å¤)
          - minor # 1.0.0 -> 1.1.0 (æ–°åŠŸèƒ½)
          - major # 1.0.0 -> 2.0.0 (é‡å¤§æ›´æ–°)
        default: "patch"
      release_notes:
        description: "å‘å¸ƒè¯´æ˜"
        required: false
        default: "æ–°ç‰ˆæœ¬å‘å¸ƒ"

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•å’Œæ ‡ç­¾

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        run: |
          # è·å–æœ€æ–°çš„ tag
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) {
            $latestTag = "v0.0.0"
          }

          Write-Host "Latest tag: $latestTag"

          # è§£æç‰ˆæœ¬å· (ç§»é™¤ 'v' å‰ç¼€)
          $version = $latestTag -replace '^v', ''
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]

          # æ ¹æ®è¾“å…¥ç±»å‹è‡ªå¢ç‰ˆæœ¬å·
          $versionType = "${{ github.event.inputs.version_type }}"
          switch ($versionType) {
            "major" {
              $major++
              $minor = 0
              $patch = 0
            }
            "minor" {
              $minor++
              $patch = 0
            }
            "patch" {
              $patch++
            }
          }

          $newVersion = "v$major.$minor.$patch"
          Write-Host "New version: $newVersion"

          # è¾“å‡ºåˆ° GitHub Actions
          echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "version_number=$major.$minor.$patch" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: è®¾ç½® .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "9.0.x"

      - name: è¿˜åŸä¾èµ–
        run: dotnet restore HarmonyOSToolbox.csproj

      - name: æ„å»ºé¡¹ç›®
        run: dotnet build HarmonyOSToolbox.csproj --configuration Release --no-restore

      - name: å‘å¸ƒåº”ç”¨ (å•æ–‡ä»¶ - éœ€è¦ .NET 9)
        run: |
          dotnet publish HarmonyOSToolbox.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=false -p:IncludeAllContentForSelfExtract=false -o publish/single-file

      - name: å‘å¸ƒåº”ç”¨ (å®Œæ•´è‡ªåŒ…å«ç‰ˆæœ¬)
        run: |
          dotnet publish HarmonyOSToolbox.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -o publish/self-contained

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          $version = "${{ steps.version.outputs.new_version }}"
          Compress-Archive -Path publish/single-file/* -DestinationPath "HarmonyOSToolbox-$version-single-file.zip"
          Compress-Archive -Path publish/self-contained/* -DestinationPath "HarmonyOSToolbox-$version-self-contained.zip"
        shell: pwsh

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: é¸¿è’™å·¥å…·ç®± ${{ steps.version.outputs.new_version }}
          body: |
            ## ğŸ“¦ ä¸‹è½½è¯´æ˜

            ### **å•æ–‡ä»¶ç‰ˆæœ¬** (çº¦ 5-10 MBï¼Œéœ€è¦ç³»ç»Ÿå·²å®‰è£… .NET 9.0 è¿è¡Œæ—¶)
            - `HarmonyOSToolbox-${{ steps.version.outputs.new_version }}-single-file.zip`
            - âœ… æ–‡ä»¶å°ï¼Œå¯åŠ¨å¿«
            - âš ï¸ **å¿…é¡»**å…ˆå®‰è£… [.NET 9.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/9.0)

            ### **å®Œæ•´è‡ªåŒ…å«ç‰ˆæœ¬** (çº¦ 80-100 MBï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–)
            - `HarmonyOSToolbox-${{ steps.version.outputs.new_version }}-self-contained.zip`
            - âœ… å¼€ç®±å³ç”¨ï¼ŒåŒ…å«å®Œæ•´ .NET è¿è¡Œæ—¶
            - âš ï¸ æ–‡ä»¶è¾ƒå¤§

            ---

            ## ğŸ“ æ›´æ–°å†…å®¹

            ${{ github.event.inputs.release_notes }}
          files: |
            HarmonyOSToolbox-${{ steps.version.outputs.new_version }}-single-file.zip
            HarmonyOSToolbox-${{ steps.version.outputs.new_version }}-self-contained.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
