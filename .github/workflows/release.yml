name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ–°ç‰ˆæœ¬å‘å¸ƒ'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'
        
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore HarmonyOSToolbox.csproj
      
    - name: æ„å»ºé¡¹ç›®
      run: dotnet build HarmonyOSToolbox.csproj --configuration Release --no-restore
      
    - name: å‘å¸ƒåº”ç”¨ (å•æ–‡ä»¶)
      run: |
        dotnet publish HarmonyOSToolbox.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -o publish/single-file
        
    - name: å‘å¸ƒåº”ç”¨ (å®Œæ•´åŒ…å«ä¾èµ–)
      run: |
        dotnet publish HarmonyOSToolbox.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o publish/self-contained
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        $version = "${{ github.event.inputs.version }}"
        Compress-Archive -Path publish/single-file/* -DestinationPath "HarmonyOSToolbox-$version-single-file.zip"
        Compress-Archive -Path publish/self-contained/* -DestinationPath "HarmonyOSToolbox-$version-self-contained.zip"
      shell: pwsh
      
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: é¸¿è’™å·¥å…·ç®± ${{ github.event.inputs.version }}
        body: |
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **å•æ–‡ä»¶ç‰ˆæœ¬** (éœ€è¦ç³»ç»Ÿå·²å®‰è£… .NET 9.0 è¿è¡Œæ—¶):
          - `HarmonyOSToolbox-${{ github.event.inputs.version }}-single-file.zip`
          
          **å®Œæ•´ç‰ˆæœ¬** (åŒ…å«æ‰€æœ‰ä¾èµ–):
          - `HarmonyOSToolbox-${{ github.event.inputs.version }}-self-contained.zip`
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          
          ${{ github.event.inputs.release_notes }}
        files: |
          HarmonyOSToolbox-${{ github.event.inputs.version }}-single-file.zip
          HarmonyOSToolbox-${{ github.event.inputs.version }}-self-contained.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
