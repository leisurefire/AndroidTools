name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ–°ç‰ˆæœ¬å‘å¸ƒ'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'
        
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore
      
    - name: æ„å»ºé¡¹ç›®
      run: dotnet build --configuration Release --no-restore
      
    - name: å‘å¸ƒåº”ç”¨ (å•æ–‡ä»¶)
      run: |
        dotnet publish -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -o ./publish/single-file
        
    - name: å‘å¸ƒåº”ç”¨ (å®Œæ•´åŒ…å«ä¾èµ–)
      run: |
        dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/self-contained
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå•æ–‡ä»¶ç‰ˆæœ¬å‹ç¼©åŒ…
        Compress-Archive -Path ./publish/single-file/* -DestinationPath ./HarmonyOSToolbox-${{ github.event.inputs.version }}-single-file.zip
        
        # åˆ›å»ºå®Œæ•´ç‰ˆæœ¬å‹ç¼©åŒ…
        Compress-Archive -Path ./publish/self-contained/* -DestinationPath ./HarmonyOSToolbox-${{ github.event.inputs.version }}-self-contained.zip
      shell: pwsh
      
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: é¸¿è’™å·¥å…·ç®± ${{ github.event.inputs.version }}
        body: |
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **å•æ–‡ä»¶ç‰ˆæœ¬** (éœ€è¦ç³»ç»Ÿå·²å®‰è£… .NET 9.0 è¿è¡Œæ—¶):
          - `HarmonyOSToolbox-${{ github.event.inputs.version }}-single-file.zip`
          - ä½“ç§¯å°ï¼Œé€‚åˆå·²å®‰è£… .NET çš„ç”¨æˆ·
          
          **å®Œæ•´ç‰ˆæœ¬** (åŒ…å«æ‰€æœ‰ä¾èµ–):
          - `HarmonyOSToolbox-${{ github.event.inputs.version }}-self-contained.zip`
          - ä½“ç§¯è¾ƒå¤§ï¼Œæ— éœ€å®‰è£… .NET è¿è¡Œæ—¶
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          
          ${{ github.event.inputs.release_notes }}
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `HarmonyOSToolbox.exe`
          4. æŒ‰ç…§åº”ç”¨å†…æç¤ºè¿æ¥è®¾å¤‡
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - ä½¿ç”¨å‰è¯·å¼€å¯æ‰‹æœºçš„ USB è°ƒè¯•æ¨¡å¼
          - å»ºè®®ä½¿ç”¨å®Œæ¯•åé‡å¯æ‰‹æœº
          - è°¨æ…å¸è½½ç³»ç»Ÿåº”ç”¨ï¼Œå¿…è¦æ—¶åšå¥½æ•°æ®å¤‡ä»½
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          ./HarmonyOSToolbox-${{ github.event.inputs.version }}-single-file.zip
          ./HarmonyOSToolbox-${{ github.event.inputs.version }}-self-contained.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}